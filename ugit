#!/usr/bin/env bash

# ugit: Undo your last oopsie in Git

# TODO: Undo git tag delete

set -euo pipefail;

installed() {
    cmd=$(command -v "${1}")

    [[ -n "${cmd}" ]] && [[ -f "${cmd}" ]]
    return ${?}
}

die() {
    >&2 echo "Fatal: ${@}"
    exit 1
}

[[ "${BASH_VERSINFO[0]}" -lt 3 ]] && die "Bash >=3 required"

deps=(fzf git awk xargs cut nl)
for dep in "${deps[@]}"; do
    installed "${dep}" || die "Missing dependency: '${dep}'"
done

display_menu() {
    printf "%s\n" "Undo [git commit]"
    printf "%s\n" "Undo [git push]"
    printf "%s\n" "Undo [git add]"
    printf "%s\n" "Undo [git pull]"
    printf "%s\n" "Undo [git commit message]"
    printf "%s\n" "Undo local branch delete [git branch -D]"
    printf "%s\n" "Undo [git reset]"
    printf "%s\n" "Undo a Merge with Conflicts"
    printf "%s\n" "Undo an Unpushed Merge Commit"
    printf "%s\n" "Undo a Pushed Merge Commit"
    printf "%s\n" "Undo stash drop/clear"
    printf "%s\n" "Undo git stash apply"
}

option=$(display_menu | nl -n ln | fzf --height 20% --reverse --pointer='·êÖ' --header='Undo your last oopsie in Git üôàÔ∏è' --preview 'git status -s' | awk '{print $1}')

undo_git_commit() {
    git reset HEAD~
    # undo last commit (don't unstage everything)
    # git reset --soft HEAD^
}

undo_git_add() {
    # show prompt to unstage files interactively
    choices=$(git ls-files | fzf --height 10% --reverse --multi --marker='ü¢Ç' --color 'marker:#B8CC52' --header="Choose Files to unstage (TAB to select)")
    git restore --staged $choices
}

change_commit_message() {
    echo -e "Enter New Commit Message (Ctrl+d to save):"
    msg=$(</dev/stdin)
    echo
    [[ "$msg" ]] && git commit --amend -m "$msg" || echo "bruh enter something!!"
}

undo_git_push() {
    commit_hash=$(git log --oneline | fzf --ansi --height 10% --reverse --multi --header="Choose Commit hash to revert/undo" | awk '{print $1}')
    git revert "$commit_hash"
    echo "Make sure to run 'git push' now"
}

undo_branch_delete() {
    # undo local branch delete
    last_branch_commit=$(git reflog | fzf --ansi --height 20% --reverse --multi --header="Choose last good branch commit" | awk '{print $1}')
    # echo "$last_branch_commit"
    read -p "Enter Branch Name: " branch_name
    git checkout -b "$branch_name" "$last_branch_commit"
}

undo_git_reset() {
    last_good_state=$(git reflog | fzf --ansi --height 20% --reverse --multi --header="Choose last known good commit" | awk '{print $1}')
    git reset "$last_good_state"
}

undo_git_merge() {
    # WIP (untested)
    if [[ "$1" == "conflicts" ]]; then
        git merge --abort
    elif [[ "$1" == "unpushed" ]]; then
        # FROM: https://stackoverflow.com/questions/1223354/undo-git-pull-how-to-bring-repos-to-old-state
        last_good_state=$(git reflog | fzf --ansi --height 20% --reverse --multi --header="Choose last good branch commit" | awk '{print $1}')
        # check if working tree is clean or not
        [[ $(git status --porcelain 2>/dev/null) ]] && read -p "You have uncommited changes, still proceed [Y/n]: " -n 1 -r USER_INPUT
        USER_INPUT=${USER_INPUT:-Y}
        [[ "$USER_INPUT" == Y ]] && git reset --hard "$last_good_state"
    else
        default_branch=$(git remote show origin | awk '/HEAD/ {print $3}')
        echo -e "Switching to default branch $default_branch"
        git checkout "$default_branch"
        commit_hash=$(git log --oneline | fzf --ansi --height 10% --reverse --multi --header="Choose appropriate hash of the merge commit" | awk '{print $1}')
        git revert -m 1 "$commit_hash"
    fi
}

recover_lost_stash() {
    lost_stash_hash=$(git fsck --no-progress --unreachable | grep commit | cut -d ' ' -f3 | xargs git log --oneline --merges --no-walk | awk '{print $1}')
    read -p "Enter Stash Message/Comment: " -r STASH_MSG
    if git update-ref refs/stash "$lost_stash_hash" --create-reflog -m "$STASH_MSG"; then
        echo "Stash Successfully Recovered"
        git stash list | grep "$STASH_MSG"
    fi
}

undo_git_stash_apply() {
    # TODO: check if diff coloring is on in git config otherwise the reverse apply command will fail
    # TODO: option to select which stash to unapply?
    git stash show -p | git apply --reverse
}

case $option in
    1) undo_git_commit;;
    2) undo_git_push;;
    3) undo_git_add;;
    4) undo_git_merge "unpushed";;
    5) change_commit_message;;
    6) undo_branch_delete;;
    7) undo_git_reset;;
    8) undo_git_merge "conflicts";;
    9) undo_git_merge "unpushed";;
    10) undo_git_merge "pushed";;
    11) recover_lost_stash;;
    12) undo_git_stash_apply;;
esac
